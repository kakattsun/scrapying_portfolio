/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
var def;require=function(t){"use strict";return t},def=window.define?window.define:function(t,e){"use strict";return e.apply(null,[{ajax:$.ajax.bind($)}])};var exports=acom_analytics={};function dependOn(){"use strict";return[require("util"),require("proxy"),require("common"),require("constant")]}def(dependOn(),(function(t,e,s){"use strict";var i,r=null;for(i in r||(r=new function(){e&&(this.proxy=e.proxy.bind(this)),chrome.runtime.onMessage.addListener((t,e,s)=>{switch(t.main_op){case"get-feature-flags":this.getFeatureFlags(t.cachePurge).then(t=>{s(t)});break;case"init-floodgate":setTimeout(()=>{this.init()},2e3)}}),this.isEmptyObject=t=>0===Object.keys(t).length,this.getFloodgateResults=(t=CACHE_PURGE_SCHEME.NONE)=>new Promise((e,s)=>{try{t&&!(t in CACHE_PURGE_SCHEME)&&(t=CACHE_PURGE_SCHEME.NONE),t!==CACHE_PURGE_SCHEME.NONE&&t!==CACHE_PURGE_SCHEME.LAZY||this.isEmptyObject(this.floodgateResults)||e(this.floodgateResults),(t===CACHE_PURGE_SCHEME.EAGER||t===CACHE_PURGE_SCHEME.LAZY||this.isEmptyObject(this.floodgateResults))&&this.callFloodgateAPI().then(t=>(this.floodgateResults=t,this.getArrayOfFlags(t),e(t)))}catch(t){s(t)}}),this.getFeatureFlags=t=>new Promise(e=>{if(0!=this.featureFlags.length&&t===CACHE_PURGE_SCHEME.NONE)return e(this.featureFlags);this.getFloodgateResults(t).then(t=>e(this.getArrayOfFlags(t))).catch(()=>e(this.featureFlags))}),this.getReleaseVariant=t=>new Promise((e,s)=>this.getFloodgateResults(CACHE_PURGE_SCHEME.EAGER).then(s=>{let i=null;s.releases.forEach(e=>{e.release_name===t&&(i=e.features[0])}),e(i)}).catch(()=>s(null))),this.hasFlag=(t,e)=>this.getFeatureFlags(e).then(e=>e.includes(t)).catch(()=>null),this.init=()=>{this.clientId=s.getViewerIMSClientId(),this.floodgateUri=s.getFloodgateuri(),this.env=s.getEnv(),this.accessToken=null,this.useAnonymousUUID=!0,this.featureFlags=[],this.floodgateResults={}},this.getApiUrl=()=>{const t=this.clientId;if(!this.floodgateUri||!t)throw new Error("missing data");return`${this.floodgateUri}/v3/feature?clientId=${t}&meta=false`},this.getArrayOfFlags=t=>{const e=t=>{try{if("object"==typeof window&&window.sessionStorage)return window.sessionStorage.getItem(t)||""}catch(t){return""}};if(t){this.featureFlags=[],t.releases.forEach(t=>{t.features.forEach(t=>this.featureFlags.push(t))});e("floodgate-add").split(/[, ]+/).forEach(t=>{this.featureFlags.includes(t)||this.featureFlags.push(t)});const s=e("floodgate-remove").split(/[, ]+/);this.featureFlags=this.featureFlags.filter(t=>!s.includes(t))}return this.featureFlags.slice()},this.uuid=()=>{try{var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var s=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?s:3&s|8).toString(16)}))}catch(t){return Math.random()}},this.createAnonUserUUID=()=>{const t=`${this.env}_${this.clientId}_${this.uuid()}`;try{localStorage.setItem("anonUserUUID",t)}catch(t){}return t},this.callFloodgateAPI=()=>{const t=this.accessToken?"Bearer "+this.accessToken:"",e={"x-api-key":this.clientId};if(this.useAnonymousUUID){try{e["x-adobe-uuid"]=localStorage.getItem("anonUserUUID")}catch(t){}e["x-adobe-uuid"]||(t?e.Authorization=t:e["x-adobe-uuid"]=this.createAnonUserUUID())}else t&&(e.Authorization=t);let s={};return fetch(this.getApiUrl(),{method:"GET",headers:e}).then(t=>{s=t;const e=t.headers.get("content-type");return t.ok&&e&&e.includes("application/json")?(this.error=void 0,t.json().then(t=>t)):t.text().then(s=>{const i=`Floodgate API failed with status ${t.status} ${t.statusText} type ${e} text ${s}`;throw new TypeError(i)})}).catch(t=>{this.error=t&&t.message?t:new Error("Floodgate failure: "+JSON.stringify(t))})}}),r)r.hasOwnProperty(i)&&("function"==typeof r[i]?exports[i]=r[i].bind(r):exports[i]=r[i]);return r}));